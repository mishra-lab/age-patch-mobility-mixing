\documentclass{article}
\usepackage{geometry}
\usepackage[colorlinks]{hyperref}
\usepackage[osf,t]{ETbb}
\usepackage[libertine]{newtxmath}
\usepackage{tikz}
\setlength{\parskip}{1ex}
\setlength{\parindent}{0ex}
\def\Xm{X^{\mathrm{m}}}
\def\triu{\mathrm{upper}}
\title{Mixing Matrices for Quasi-Spatial Population Stratification:\\Adjacency Approach}
\date{21 April, 2021}
\author{Jesse Knight}
\begin{document}
  \maketitle
  \section{Objective}\label{s:obj}
  The population is stratified into $N = 513$ ``FSA'' (neighbourhoods) indexed $n$.
  Each FSA has $P_n$ population size, average number of contacts $C_n$,
  and is assigned to one of $G = 10$ groups indexed $g$;
  then $S_g$ denotes the set of $n$ assigned to group $g$.
  We are interested in constructing a mixing matrix $M_{gg'}$ describing
  the probability of contact formation between an average individual in group $g$
  with an average individual in group $g'$.
  The properties of $M_{gg'}$ include:
  \begin{enumerate}
    \item\label{c:bound}   Bounded:    $0 \le M_{gg'} \le 1$
    \item\label{c:sum}     Sum to One: $1 = \sum_{g'} M_{gg'}$
    \item\label{c:balance} Balance:    $P_g C_g M_{gg'} = P_{g'} C_{g'} M_{g'g}$
  \end{enumerate}
  \section{Toy Example: Adjacent Mixing}\label{s:toy}
  Consider the example network in Figure~\ref{fig:graph} with 5 FSAs: $A,B,C,D,E$.
  The FSA sizes are $P_n = [17,10,5,5,3]$, with $S_1 = \{A,D\}$ (red), and $S_2 = \{B,C,E\}$ (blue).
  For now, we assume $C_n = 1$.
  The adjacency matrix $\Lambda$ is:
  \begin{equation}
  \Lambda_{nn'} = \left[\begin{matrix}
  	* & 1 & 1 & 1 & 0 \\
  	1 & * & 1 & 0 & 0 \\
  	1 & 1 & * & 1 & 0 \\
  	1 & 0 & 1 & * & 1 \\
  	0 & 0 & 0 & 1 & *
  \end{matrix}\right]
  \end{equation}
  \begin{figure}
    \centering\input{toy.tikz}
    \caption{Diagram of toy FSA network:
      size (area), adjacency/external contacts (solid lines), internal contacts (dotted), and groupings (colour)}
    \label{fig:graph}
  \end{figure}
  \subsection{Balancing FSA Contacts}
  Let $Q_n = P_n C_n$ be the total number of contacts made available by FSA $n$.
  We begin by exploring the absolute number of contacts formed between pairs of FSAs, denoted $X_{nn'}$.
  Consider $X_{DE}$. If we assumed proportionate mixing between adjacent FSAs, then from $D$'s perspective:
  \begin{equation}
    X_{DE} = Q_D \frac{Q_E}{Q_D + Q_A + Q_C + Q_E}
  \end{equation}
  But from $E$'s perspective:
  \begin{equation}
    X_{ED} = Q_E \frac{Q_D}{Q_D + Q_E}
  \end{equation}
  Yet, we must have balanced contacts, $X_{DE} = X_{ED}$.
  In the approach above, ``highly connected'' FSAs (e.g.~$D$)
  would expect fewer contacts with each adjacent FSA,
  whereas ``minimally connected'' FSAs (e.g.~$E$)
  would expect more contacts with each adjacent FSA.%
  \footnote{To be precise, the expected number of contacts also depends on
    the relative sizes of adjacent FSAs.}
  One way to assume a ``compromise'' would be to define a weighted average for the number of contacts formed
  with weights $\omega$:
  \begin{align}
    X^\omega_{DE} = X^\omega_{ED}
    &= (Q_D Q_E) \left[\frac{\omega_D}{Q_D + Q_A + Q_C + Q_E}+\frac{\omega_E}{Q_D + Q_E}\right]\\
    &= (Q_D Q_E) \frac{\omega_D T_E + \omega_E T_D}{T_D T_E},\quad\textrm{where}
    \begin{cases}
      T_D = Q_D + Q_A + Q_C + Q_E\\
      T_E = Q_D + Q_E\\
    \end{cases}\nonumber
  \end{align}
  However, a danger of the compromise approach is that
  the adjacent FSAs may ``request'' more contacts than is possible for a highly connected FSA to ``provide''.
  A safer definition of $X_{DE}$ could use the smaller number of expected contacts expected by either FSA:
  \begin{align}
    \Xm_{DE}
    &= \min{\left\{X_{DE},X_{ED}\right\}}\\
    &= \frac{Q_D Q_E}{\max{\{T_D,T_E\}}}\nonumber
  \end{align}
  More generally, and considering the adjacency matrix:
  \begin{equation}
    \Xm_{nn'} = \frac{Q_{n} Q_{n'}}{\max{\{T_{n},T_{n'}\}}}\Lambda_{nn'}
  \end{equation}
  The implication of this approach is that the more highly connected FSA will limit
  the number of contacts formed with other FSAs.
  We can further assume that the less connected FSAs would form the remaining contacts internally (within the same FSA)
  by adjusting the contact matrix:
  \begin{equation}
    X_{nn'} =  \Xm_{nn'} + \mathrm{diag}\left(Q_n-\sum_{n'} \Xm_{nn'}\right)
  \end{equation}
  \subsection{Aggregating FSAs}
  The next step is to obtain $M_{gg'}$ from $X_{nn'}$.
  The total number of contacts formed between group $g$ and group $g'$ can be defined as:%
  \footnote{It may seem like we are double-counting off-diagonal elements of $X_{nn'}$,
    since these represent the same contacts as across the diagonal.
    In fact, the diagonal elements are already effectively double-counted
    due to forming contacts with themselves.\\[1ex]
    Also, if $Z_{ng}$ is a $N \times G$ indicator matrix,
    then $X_{gg'}$ can also be obtained by matrix multiplication: $Z_{ng} X_{nn'} Z_{n'g'}^\intercal$.}
  \begin{equation}
    X_{gg'} = \sum_{n \in S_g} \sum_{n' \in S_{g'}} X_{nn'}
  \end{equation}
  To resolve the mixing matrix $M_{gg'}$, we first define
  the total number of contacts made available by each group $g$
  as the sum of constitutive FSAs:
  \begin{equation}
    Q_g = \sum_{n \in S_g} Q_n
  \end{equation}
  Then, since $X_{gg'}$ is defined as the product of $Q_g$ with $M_{gg'}$ (constraint~\ref{c:balance}),
  we can define $M_{gg'}$ as:
  \begin{equation}
    M_{gg'} = \frac{X_{gg'}}{Q_g}
  \end{equation}
  Following the approach above for the toy network, we obtain:
  \begin{subequations}
  \begin{align}
    X_{nn'} &=
    \left[\begin{matrix}
      7.81 & 4.59 & 2.30 & 2.30 & 0    \\
      4.59 & 4.05 & 1.35 & 0    & 0    \\
      2.30 & 1.35 & 0.68 & 0.68 & 0    \\
      2.30 & 0    & 0.68 & 1.53 & 0.50 \\
      0    & 0    & 0    & 0.50 & 2.50 \\
    \end{matrix}\right]
    \\ X_{gg'} &=
    \left[\begin{matrix}
     13.93 & 8.07 \\
      8.07 & 9.93 \\
    \end{matrix}\right]
    \\ Q_{g} &=
    \left[\begin{matrix}
    22 & 18 \\
    \end{matrix}\right]
    \\ M_{gg'} &=
    \left[\begin{matrix}
      .63 & .37 \\
      .45 & .55 \\
    \end{matrix}\right]
  \end{align}
  \end{subequations}
  \section{More Types of Mixing}\label{s:more}
  In Section~\ref{s:toy}, we assumed quasi-proportionate mixing amongst adjacent FSAs.
  We might also assume some global proportionate ($r$) mixing across all FSAs
  (such as for individuals travelling long distances),
  or some strictly assortative ($i$) mixing within FSAs
  (such as household contacts).
  The mixing matrices for these cases are:
  \begin{equation}
    M_{gg'}^{r} = \frac{Q_{g'}}{\sum_{g'}Q_{g'}}
    ,\qquad
    M_{gg'}^{i} = \begin{cases} 1 & g = g'\\0 & g \ne g' \end{cases}
  \end{equation}
  Assuming $\epsilon_r$, $\epsilon_i$, and $\epsilon_a$, proportions of individuals form contacts
  through global proportionate, strictly assortative, and adjacent ($a$) mixing,
  we can define a final $M_{gg'}$ as:%
  \footnote{It can be shown that this approach can be implemented in terms of
    either FSAs ($nn'$) or groups ($gg'$) with equivalent results.}
  \begin{equation}
    M_{gg'} = \epsilon_r M_{gg'}^r + \epsilon_i M_{gg'}^i + \epsilon_a M_{gg'}^a
  \end{equation}
\end{document}
